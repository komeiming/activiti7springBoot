<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itheima.activiti.mapper.ApiCallLogMapper">
    
    <!-- 插入API调用日志 -->
    <insert id="insert" parameterType="com.itheima.activiti.entity.ApiCallLog">
        INSERT INTO api_call_log (
            id,
            app_id,
            tenant_id,
            api_path,
            request_method,
            request_params,
            response_data,
            response_time,
            success,
            error_code,
            error_message,
            client_ip,
            call_time
        ) VALUES (
            #{id},
            #{appId},
            #{tenantId},
            #{apiPath},
            #{requestMethod},
            #{requestParams},
            #{responseData},
            #{responseTime},
            #{success},
            #{errorCode},
            #{errorMessage},
            #{clientIp},
            #{callTime}
        )
    </insert>
    
    <!-- 根据条件查询API调用日志 -->
    <select id="selectByCondition" parameterType="java.util.Map" resultType="com.itheima.activiti.entity.ApiCallLog">
        SELECT * FROM api_call_log
        WHERE 1=1
        <if test="appId != null">
            AND app_id = #{appId}
        </if>
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="success != null">
            AND success = #{success}
        </if>
        <if test="startTime != null and endTime != null">
            AND call_time BETWEEN #{startTime} AND #{endTime}
        </if>
        ORDER BY call_time DESC
        <if test="page != null and size != null">
            LIMIT #{size} OFFSET #{page}
        </if>
    </select>
    
    <!-- 查询API调用日志总数 -->
    <select id="countByCondition" parameterType="java.util.Map" resultType="int">
        SELECT COUNT(*) FROM api_call_log
        WHERE 1=1
        <if test="appId != null">
            AND app_id = #{appId}
        </if>
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="success != null">
            AND success = #{success}
        </if>
        <if test="startTime != null and endTime != null">
            AND call_time BETWEEN #{startTime} AND #{endTime}
        </if>
    </select>
    
    <!-- 根据APP ID查询API调用统计 -->
    <select id="selectStatsByAppId" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
            DATE(call_time) as date,
            COUNT(*) as count,
            SUM(response_time) as totalResponseTime,
            AVG(response_time) as avgResponseTime
        FROM api_call_log
        WHERE app_id = #{appId}
        <if test="startTime != null and endTime != null">
            AND call_time BETWEEN #{startTime} AND #{endTime}
        </if>
        GROUP BY DATE(call_time)
        ORDER BY date
    </select>
</mapper>