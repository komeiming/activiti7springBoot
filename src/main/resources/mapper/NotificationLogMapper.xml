<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itheima.activiti.mapper.NotificationLogMapper">
    
    <resultMap id="BaseResultMap" type="com.itheima.activiti.entity.NotificationLog">
        <id column="id" property="id" />
        <result column="send_id" property="sendId" />
        <result column="template_id" property="templateId" />
        <result column="template_name" property="templateName" />
        <result column="type" property="type" />
        <result column="receiver" property="receiver" />
        <result column="params" property="params" />
        <result column="sender_system" property="senderSystem" />
        <result column="request_id" property="requestId" />
        <result column="success" property="success" />
        <result column="error_code" property="errorCode" />
        <result column="error_message" property="errorMessage" />
        <result column="send_time" property="sendTime" />
        <result column="tenant_id" property="tenantId" />
    </resultMap>
    
    <sql id="Base_Column_List">
        id, send_id, template_id, template_name, type, receiver, params, 
        sender_system, request_id, success, error_code, error_message, send_time, tenant_id
    </sql>
    
    <!-- 按条件查询日志 -->
    <select id="findByCondition" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM notification_log
        <where>
            <if test="templateId != null and templateId != ''">
                AND template_id = #{templateId}
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="success != null">
                AND success = #{success}
            </if>
            <if test="startTime != null">
                AND send_time >= #{startTime}
            </if>
            <if test="endTime != null">
                <![CDATA[AND send_time <= #{endTime}]]>
            </if>
            <if test="receiver != null and receiver != ''">
                AND receiver LIKE CONCAT('%', #{receiver}, '%')
            </if>
        </where>
        ORDER BY send_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>
    
    <!-- 根据发送ID查询日志 -->
    <select id="findBySendId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM notification_log
        WHERE send_id = #{sendId}
    </select>
    
    <!-- 根据模板ID查询日志 -->
    <select id="findByTemplateId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM notification_log
        WHERE template_id = #{templateId}
        ORDER BY send_time DESC
    </select>
    
    <!-- 查询发送失败的日志 -->
    <select id="findFailedLogs" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM notification_log
        WHERE success = 0
        <if test="startTime != null">
            AND send_time >= #{startTime}
        </if>
        <if test="endTime != null">
                <![CDATA[AND send_time <= #{endTime}]]>
            </if>
        ORDER BY send_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>
    
    <!-- 统计日志数量 -->
    <select id="countLogs" resultType="int">
        SELECT COUNT(*)
        FROM notification_log
        <where>
            <if test="templateId != null and templateId != ''">
                AND template_id = #{templateId}
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="success != null">
                AND success = #{success}
            </if>
            <if test="startTime != null">
                AND send_time >= #{startTime}
            </if>
            <if test="endTime != null">
                <![CDATA[AND send_time <= #{endTime}]]>
            </if>
            <if test="tenantId != null and tenantId != ''">
                AND tenant_id = #{tenantId}
            </if>
        </where>
    </select>
    
    <!-- 查询所有日志 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM notification_log
        ORDER BY send_time DESC
    </select>
    
    <!-- 根据ID查询日志 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM notification_log
        WHERE id = #{id}
    </select>
    
    <!-- 插入日志 -->
    <insert id="insert">
        INSERT INTO notification_log (id, send_id, template_id, template_name, type, receiver, params, sender_system, request_id, success, error_code, error_message, send_time, tenant_id)
        VALUES (#{id}, #{sendId}, #{templateId}, #{templateName}, #{type}, #{receiver}, #{params}, #{senderSystem}, #{requestId}, #{success}, #{errorCode}, #{errorMessage}, #{sendTime}, #{tenantId})
    </insert>
    
    <!-- 按条件查询日志 -->
    <select id="selectByParams" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM notification_log
        <where>
            <if test="id != null and id != ''">
                AND id = #{id}
            </if>
            <if test="sendId != null and sendId != ''">
                AND send_id = #{sendId}
            </if>
            <if test="templateId != null and templateId != ''">
                AND template_id = #{templateId}
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="receiver != null and receiver != ''">
                AND receiver LIKE CONCAT('%', #{receiver}, '%')
            </if>
            <if test="success != null">
                AND success = #{success}
            </if>
            <if test="startTime != null">
                AND send_time >= #{startTime}
            </if>
            <if test="endTime != null">
                <![CDATA[AND send_time <= #{endTime}]]>
            </if>
            <if test="tenantId != null and tenantId != ''">
                AND tenant_id = #{tenantId}
            </if>
        </where>
        ORDER BY send_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>
    
    <!-- 批量插入日志 -->
    <insert id="batchInsert">
        INSERT INTO notification_log (id, send_id, template_id, template_name, type, receiver, params, sender_system, request_id, success, error_code, error_message, send_time, tenant_id)
        VALUES
        <foreach collection="list" item="log" separator=",">
            (#{log.id}, #{log.sendId}, #{log.templateId}, #{log.templateName}, #{log.type}, #{log.receiver}, #{log.params}, #{log.senderSystem}, #{log.requestId}, #{log.success}, #{log.errorCode}, #{log.errorMessage}, #{log.sendTime}, #{log.tenantId})
        </foreach>
    </insert>
</mapper>
